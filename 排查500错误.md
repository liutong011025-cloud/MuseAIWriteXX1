# 排查 /api/auth 500 错误

## 🔍 错误原因

`/api/auth` 返回 500 错误，通常是因为：

1. **数据库连接失败** - `DATABASE_URL` 环境变量未配置或配置错误
2. **数据库无法访问** - 数据库服务器不允许 Vercel 的网络访问
3. **Prisma Client 初始化失败** - 数据库连接字符串格式错误

## ✅ 解决步骤

### 步骤 1: 检查 Vercel 环境变量

1. 登录 Vercel: https://vercel.com/dashboard
2. 选择项目 `MuseAIX9`
3. 进入 **Settings** → **Environment Variables**
4. 确认 `DATABASE_URL` 已配置

### 步骤 2: 验证 DATABASE_URL 格式

`DATABASE_URL` 应该是这样的格式：

```
postgresql://用户名:密码@主机地址:端口/数据库名?schema=public
```

示例：
```
postgresql://postgres:mypassword@db.example.com:5432/museaiwrite?schema=public
```

### 步骤 3: 检查数据库访问权限

确保数据库服务器允许 Vercel 的 IP 地址访问：

- **如果使用 Vercel Postgres**：自动配置，无需额外设置
- **如果使用外部数据库**：
  - 检查防火墙规则
  - 确保数据库允许外部连接
  - 检查 IP 白名单（如果需要）

### 步骤 4: 查看 Vercel 日志

1. 在 Vercel 项目页面，点击 **Deployments**
2. 选择最新的部署
3. 点击 **View Function Logs** 或 **View Build Logs**
4. 查看错误详情，寻找：
   - `PrismaClientInitializationError`
   - `Can't reach database server`
   - `Connection refused`

### 步骤 5: 测试数据库连接

在 Vercel 的 **Functions** 页面，可以查看实时日志：

1. 进入项目 → **Functions**
2. 尝试登录，观察日志输出
3. 查看具体的错误信息

## 🔧 快速修复

### 如果使用 Vercel Postgres

1. 在 Vercel 项目设置中，点击 **Storage**
2. 创建新的 Postgres 数据库（如果还没有）
3. 在数据库设置中，复制 **Connection String**
4. 在 **Environment Variables** 中，添加 `DATABASE_URL` = 连接字符串
5. 重新部署项目

### 如果使用外部 PostgreSQL

1. 确认数据库服务器运行正常
2. 确认数据库允许外部连接（检查 `postgresql.conf` 和 `pg_hba.conf`）
3. 确认防火墙规则允许 Vercel 访问
4. 在 Vercel 中配置正确的 `DATABASE_URL`
5. 重新部署项目

## 📋 检查清单

- [ ] `DATABASE_URL` 环境变量已在 Vercel 中配置
- [ ] `DATABASE_URL` 格式正确
- [ ] 数据库服务器运行正常
- [ ] 数据库允许外部连接
- [ ] 防火墙规则已配置
- [ ] 已重新部署项目

## 🚨 常见错误信息

### "Can't reach database server"
- 数据库服务器无法访问
- 检查主机地址和端口
- 检查防火墙规则

### "PrismaClientInitializationError"
- `DATABASE_URL` 格式错误
- 检查连接字符串格式

### "Connection refused"
- 数据库服务器拒绝了连接
- 检查数据库配置和访问权限

## 💡 建议

如果问题持续存在：

1. **使用 Vercel Postgres**（最简单）
   - 在 Vercel 中直接创建 Postgres 数据库
   - 自动配置连接，无需额外设置

2. **检查网络连接**
   - 确保数据库服务器可以从互联网访问
   - 检查是否有 VPN 或私有网络限制

3. **查看详细日志**
   - 在 Vercel 的 Functions 日志中查看具体错误
   - 根据错误信息进行针对性修复

